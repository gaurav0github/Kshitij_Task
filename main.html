<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.1.0/mdb.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
  <title>MyPhotos</title>
  <style>
    .aImg,
    #myimg {
      height: 200px;
      width: 200px;
      border: 2px black solid;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />
  <link rel="icon" href="images.png" type="image/gif" sizes="16x16" />
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <!-- Container wrapper -->
    <div class="container-fluid ml-sm-2 p-0">
      <!-- Toggle button -->
      <button class="first-button noBorder" id="doToggle" type="button" data-mdb-toggle="collapse"
        data-mdb-target="#myNavbarToggler7"
        aria-controls="myNavbarToggler7" aria-expanded="false"
        aria-label="Toggle navigation">
        <div class="animated-icon1"><span></span><span></span><span></span></div>
      </button>
      <!-- Navbar brand -->
      <a class="navbar-brand mt-2 mt-lg-0 mr-auto ml-2" href="/index.html">
        <img src="images.png" width="30" height="30" alt="MDB Logo" class="d-inline-block align-top mx-0" />
        <span id="logo-name">Kshitij</span>
      </a>
      <!-- Collapsible wrapper -->
      <div class="container-fluid d-none d-lg-block w-50">
        <form class="d-flex input-group">
          <input type="search" class="form-control rounded" placeholder="Search" aria-label="Search"
            aria-describedby="search-addon" />
          <span class="input-group-text border-0" id="search-addon">
            <i class="fas fa-search"></i>
          </span>
        </form>
      </div>
      <!-- Right elements -->
      <!-- <label>Image Name</label> -->
      <input type="text" class="d-none" id="namebox" />
      <label class="d-none" id="extlab"></label>
      <img class="d-none" id="myimg" /> <label id="upprogress"></label>
      <!-- <button id="selbtn">Select Image</button>
      <button id="upbtn">Upload Image</button> -->
      <div class="d-flex align-items-center">
        <div id="selbtn" class="pcursor">
          <span class="bi bi-folder ml-3" style="font-size:1.5em"></span>
          Select Photos
        </div>
        <div id="upbtn" class="pcursor">
          <a class="nav-link mx-3 d-flex">
            <i class="fas fa-upload" id="upbtn" style="font-size: 1.5em;"></i>
            <span id="">&nbspUpload</span>
        </div>
        </a>
        <!-- Notifications -->
        <div class="dropdown mx-3">
          <a class="link-secondary dropdown-toggle hidden-arrow" href="#" id="navbarDropdownMenuLink" role="button"
            data-mdb-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-bell" style="font-size: 1.7em;"></i>
            <span class="badge rounded-pill badge-notification bg-danger">5</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
            <li>
              <a class="dropdown-item" href="#">Some news</a>
            </li>
            <li>
              <a class="dropdown-item" href="#">Another news</a>
            </li>
            <li>
              <a class="dropdown-item" href="#">Something else here</a>
            </li>
          </ul>
        </div>
        <!-- Avatar -->
        <div class="dropdown mx-3">
          <a class="dropdown-toggle d-flex align-items-center hidden-arrow" href="#" id="navbarDropdownMenuAvatar"
            role="button" data-mdb-toggle="dropdown" aria-expanded="false">
            <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle" height="34"
              alt="Black and White Portrait of a Man" loading="lazy" />
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
            <li>
              <a class="dropdown-item" href="#">My profile</a>
            </li>
            <li>
              <a class="dropdown-item" href="#">Settings</a>
            </li>
            <li>
              <a class="dropdown-item" href="#">Logout</a>
            </li>
          </ul>
        </div>
      </div>
      <!-- Right elements -->
    </div>
    <!-- Container wrapper -->
  </nav>
  <!-- Navbar -->


  <div class="d-flex" id="wrapper">
    <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark wholespace overflow-y-auto mx-0" id="toToggle">
      <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
        <svg class="bi me-2" width="40" height="32">
          <use xlink:href="#bootstrap"></use>
        </svg>
        <span class="fs-4">Folders</span>
      </a>
      <hr>
      <ul class="nav nav-pills flex-column mb-auto sidebar-items">
        <li class="nav-item">
          <a href="#" class="nav-link text-white myButton" aria-current="page">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#home"></use>
            </svg>
            Home
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#speedometer2"></use>
            </svg>
            Dashboard
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#table"></use>
            </svg>
            Orders
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#grid"></use>
            </svg>
            Products
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#people-circle"></use>
            </svg>
            Customers
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#speedometer2"></use>
            </svg>
            Dashboard
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#table"></use>
            </svg>
            Orders
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#grid"></use>
            </svg>
            Products
          </a>
        </li>
        <li>
          <a href="#" class="nav-link text-white myButton">
            <svg class="bi me-2" width="16" height="16">
              <use xlink:href="#people-circle"></use>
            </svg>
            Customers
          </a>
        </li>
      </ul>
      <hr>
    </div>

    <div class="mr-auto wholespace overflow-y-auto" id="imagespace">
      
    </div>
  </div>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.1.0/mdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
    <!-- ----------------FIREBASE------------------->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBXtCjMez8dw82Oqux39X2AFSeba6p-w60",
        authDomain: "kshitijtask.firebaseapp.com",
        databaseURL: "https://kshitijtask-default-rtdb.firebaseio.com",
        projectId: "kshitijtask",
        storageBucket: "kshitijtask.appspot.com",
        messagingSenderId: "941950928310",
        appId: "1:941950928310:web:4265c56ad67e5c78552d17",
      };
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      import {
        getStorage,
        ref as sRef,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-storage.js";
      import {
        getDatabase,
        ref,
        set,
        child,
        get,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js";
      const db = getDatabase();
      // -------------REFERENCES----------------
      var currentUser = null;
      // -------------------FUNCTIONS-----------------------
      function getUsername() {
        // window.alert("Fetching username");
        let keepLoggedIn = localStorage.getItem("keepLoggedIn");
        if (keepLoggedIn == "yes") {
          currentUser = JSON.parse(localStorage.getItem("user"));
        } else {
          currentUser = JSON.parse(sessionStorage.getItem("user"));
        }
      }
      function Signout() {
        // window.alert("SignOut iniated");
        sessionStorage.removeItem("user");
        localStorage.removeItem("user");
        localStorage.removeItem("keepLoggedIn");
        window.location = "login.html";
      }
      // --------------WINDOW ONLOAD--------------------
      window.onload = function () {
        getUsername();
        if (currentUser == null) {
          // window.alert("Window load without user ocurred");
        } else {
          // window.alert("Window load with user ocurred");
          let path=`UsersList/${currentUser.username}/allImages`;
          showImages();
        }
      };
        // -------------VARIABLES AND REFERENCES--------------
        var files = [];
      var reader = new FileReader();
      var namebox = document.getElementById("namebox");
      var extlab = document.getElementById("extlab");
      var myimg = document.getElementById("myimg");
      var proglab = document.getElementById("upprogress");
      var SelBtn = document.getElementById("selbtn");
      var UpBtn = document.getElementById("upbtn");
      var DownBtn = document.getElementById("downbtn");
      var input = document.createElement("input");
      input.type = "file";
      input.onchange = (e) => {
        files = e.target.files;
        var extention = GetFileExt(files[0]);
        var name = GetFileName(files[0]);
        namebox.value = name;
        extlab.innerHTML = extention;
        reader.readAsDataURL(files[0]);
      };
      reader.onload = function () {
        myimg.src = reader.result;
      };

      //   --------------SELECTION------------------
      SelBtn.onclick = function () {
        input.click();
      };
      function GetFileExt(file) {
        var temp = file.name.split(".");
        var ext = temp.slice(temp.length - 1, temp.length);
        window.alert("Click on upload to save the pic");
        return "." + ext[0];
      }
      function GetFileName(file) {
        var temp = file.name.split(".");
        var fname = temp.slice(0, -1).join(".");
        return fname;
      }
      //   ----------------UPLOAD PROCESS-------------------
      async function UploadProcess() {
        var ImgToUpload = files[0];
        var ImgName = namebox.value + extlab.innerHTML;
        if (!ValidateName()) {
          alert('name cannot contain ".","#","$","[", or "]"');
          return;
        }
        const metaData = {
          contentType: ImgToUpload.type,
        };
        const storage = getStorage();
        const stroageRef = sRef(storage, "Images/" + ImgName);
        const UploadTask = uploadBytesResumable(
          stroageRef,
          ImgToUpload,
          metaData
        );
        UploadTask.on(
          "state-changed",
          (snapshot) => {
            var progess =
              (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            proglab.innerHTML = "Uploading " + progess + "%";
          },
          (error) => {
            alert("error: image not uploaded!");
          },
          () => {
            getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
              SaveURLtoRealtimDB(downloadURL);
            });
          }
        );
      }
      //   --------FUNCTIONS FOR REALTIME DATABASE-------------
      function SaveURLtoRealtimDB(URL) {
        var name = namebox.value;
        var ext = extlab.innerHTML;
        if(currentUser==null)
        {
          window.alert("Please log in first!");
          return;
        }
        let path=`UsersList/${currentUser.username}/allImages/`;
        set(ref(db, path + name), {
          ImageName: name + ext,
          ImgUrl: URL,
        });
        window.alert("Image saved");
        window.location="main.html";
      }
      function GetUrlfromRealtimDB() {
        var name = namebox.value;
        var dbRef = ref(db);
        if(currentUser==null)
        {
          window.alert("Please log in first!");
          console.log("OK");
          window.location="main.html";
          return;
        }
        let path=`UsersList/${currentUser.username}/allImages/`;
        get(child(dbRef, path + name)).then((snapshot) => {
          if (snapshot.exists()) {
            myimg.src = snapshot.val().ImgUrl;
          }
        });
      }
      function showImages(){
        var dbRef = ref(db);
        var container=document.getElementById("imagespace");
        let path=`UsersList/${currentUser.username}/allImages`;
        console.log(path);
        get(child(dbRef,path)).then((snapshot)=>{
          snapshot.forEach(function(childSnapshot){
            var key=childSnapshot.key;
            var childData=childSnapshot.val();
            container.innerHTML+="<img class='aImg' src='" + childData.ImgUrl + "' alt='Image' />";
          });
        })
      }
      function ValidateName() {
        var regex = /[\.#$\[\]]/;
        return !regex.test(namebox.value);
      }
      UpBtn.onclick = UploadProcess;
      DownBtn.onclick = GetUrlfromRealtimDB;
      </script>

    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="main.css" />
  <script src="main.js"></script>
</body>

</html>